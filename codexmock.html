<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GK Mock Test | Proctored</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      --brand: #3b82f6;
      --accent: #22c55e;
      --warning: #f97316;
      --danger: #ef4444;
      --info: #0ea5e9;
      --slate: #0f172a;
    }
    body {
      background: #f8fafc;
      color: #0f172a;
    }
    .hero {
      background: linear-gradient(120deg, #0f172a, #1e293b);
      color: #fff;
    }
    .card-shadow {
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.1);
    }
    .attempt-badge {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #fff;
      margin: 4px;
      cursor: pointer;
      border: none;
    }
    .attempt-current { background: var(--danger); }
    .attempt-answered { background: var(--accent); }
    .attempt-skipped { background: var(--info); }
    .attempt-unseen { background: #94a3b8; }

    .option-btn {
      border: 1px solid #cbd5f5;
      border-radius: 12px;
      padding: 14px 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      width: 100%;
      background: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .option-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(59, 130, 246, 0.15);
    }
    .option-letter {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: #e2e8f0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #0f172a;
    }
    .option-selected {
      border-color: var(--brand);
      box-shadow: 0 10px 18px rgba(59, 130, 246, 0.2);
      background: rgba(59, 130, 246, 0.08);
    }
    .proctor-status {
      font-size: 0.9rem;
    }
    .status-pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .pill-safe { background: rgba(34, 197, 94, 0.15); color: #15803d; }
    .pill-warn { background: rgba(249, 115, 22, 0.15); color: #c2410c; }
    .pill-danger { background: rgba(239, 68, 68, 0.15); color: #b91c1c; }

    video, canvas {
      width: 100%;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
    }
    .result-card {
      background: #fff;
      border-radius: 18px;
      border: 1px solid #e2e8f0;
      padding: 20px;
    }
    #attempt-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-start;
    }
  </style>
</head>
<body>
  <header class="hero py-4">
    <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
      <div>
        <h1 class="h3 mb-1">Professional GK Mock Test</h1>
        <p class="mb-0 text-white-50">Secure, proctored, and results-ready with live monitoring.</p>
      </div>
      <div class="d-flex gap-3">
        <span class="status-pill pill-safe"><i class="bi bi-shield-check"></i> AI Proctoring</span>
        <span class="status-pill pill-warn"><i class="bi bi-camera-video"></i> Face Tracking</span>
      </div>
    </div>
  </header>

  <main class="container py-4">
    <section id="login-section" class="row g-4">
      <div class="col-lg-7">
        <div class="card card-shadow border-0">
          <div class="card-body p-4">
            <h2 class="h4 mb-3">Candidate Login</h2>
            <p class="text-muted">Enter your details to start the test. Seat No. must follow <strong>T00xxxx</strong> format.</p>
            <form id="login-form" class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Full Name</label>
                <input id="candidate-name" type="text" class="form-control" placeholder="e.g., Sujal Wagholikar" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Seat No.</label>
                <input id="candidate-seat" type="text" class="form-control" placeholder="T001234" required />
                <small class="text-muted">Format: T00xxxx</small>
              </div>
              <div class="col-12">
                <label class="form-label">Camera Snapshot (mandatory)</label>
                <div class="row g-3">
                  <div class="col-md-6">
                    <video id="login-video" autoplay muted playsinline></video>
                  </div>
                  <div class="col-md-6">
                    <canvas id="login-snapshot" height="240"></canvas>
                    <button type="button" id="capture-btn" class="btn btn-outline-primary w-100 mt-2">
                      <i class="bi bi-camera"></i> Capture Snapshot
                    </button>
                    <div id="snapshot-status" class="text-danger small mt-1"></div>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <div class="alert alert-warning d-flex align-items-center gap-2">
                  <i class="bi bi-exclamation-triangle"></i>
                  <span>AI proctoring will start once you begin. Maintain clear face visibility to avoid auto-submit.</span>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary btn-lg" type="submit">Start Test</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="card card-shadow border-0">
          <div class="card-body p-4">
            <h3 class="h5">Test Instructions</h3>
            <ul class="text-muted">
              <li>10 random GK questions, 1 mark each.</li>
              <li>Live face tracking must remain active.</li>
              <li>5 warnings will auto-submit the test.</li>
              <li>Use the attempt panel to navigate questions.</li>
            </ul>
            <div class="alert alert-info">
              Ensure your camera works before starting.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="test-section" class="d-none">
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card card-shadow border-0">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h2 class="h5" id="question-title">Question</h2>
                  <p class="text-muted" id="question-text">Loading...</p>
                </div>
                <div class="text-end">
                  <span class="badge text-bg-secondary" id="question-counter">1 / 10</span>
                  <div class="small text-muted">Candidate: <span id="candidate-display"></span></div>
                </div>
              </div>
              <div class="row g-3" id="options-container"></div>
              <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-outline-secondary" id="prev-btn"><i class="bi bi-arrow-left"></i> Previous</button>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-warning" id="skip-btn"><i class="bi bi-skip-forward"></i> Skip</button>
                  <button class="btn btn-primary" id="next-btn">Next <i class="bi bi-arrow-right"></i></button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card card-shadow border-0 mb-4">
            <div class="card-body p-4">
              <h3 class="h6">Live Proctoring</h3>
              <video id="proctor-video" autoplay muted playsinline></video>
              <div class="mt-3">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="status-pill pill-safe" id="face-status"><i class="bi bi-emoji-smile"></i> Face Visible</span>
                  <span class="badge text-bg-danger" id="warning-count">Warnings: 0/5</span>
                </div>
                <p class="proctor-status text-muted mt-2" id="proctor-log">Monitoring active. Keep your face visible.</p>
                <div class="alert alert-secondary small mb-0">
                  Malpractice monitor checks for tab switch, multiple faces, and camera loss.
                </div>
              </div>
            </div>
          </div>

          <div class="card card-shadow border-0">
            <div class="card-body p-4">
              <h3 class="h6">Attempt Panel</h3>
              <div id="attempt-panel" class="mb-3"></div>
              <button class="btn btn-success w-100" id="submit-btn">
                <i class="bi bi-check-circle"></i> Submit Test
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="result-section" class="d-none">
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="result-card card-shadow">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h2 class="h4 mb-1">Result Summary</h2>
                <p class="text-muted" id="result-subtitle"></p>
              </div>
              <button class="btn btn-outline-primary" id="download-pdf-btn">
                <i class="bi bi-download"></i> Download Result PDF
              </button>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <div class="p-3 border rounded-3 text-center">
                  <h3 class="h2" id="score-display">0</h3>
                  <p class="text-muted mb-0">Total Score</p>
                </div>
              </div>
              <div class="col-md-8">
                <canvas id="result-chart" height="140"></canvas>
              </div>
            </div>
            <hr />
            <h3 class="h5">Detailed Analysis</h3>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Question</th>
                    <th>Your Answer</th>
                    <th>Correct Answer</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="result-table"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="result-card card-shadow">
            <h3 class="h6">Candidate Snapshot</h3>
            <img id="result-snapshot" alt="Candidate snapshot" class="img-fluid rounded-3 border" />
            <div class="mt-3">
              <p class="text-muted mb-1">Proctoring Summary</p>
              <ul class="small text-muted mb-0" id="proctor-summary"></ul>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const QUESTIONS = [
      {
        question: "Which planet is known as the Red Planet?",
        options: ["Mercury", "Mars", "Jupiter", "Saturn"],
        answer: 1
      },
      {
        question: "Who wrote the national anthem of India?",
        options: ["Rabindranath Tagore", "Bankim Chandra Chatterjee", "Sarojini Naidu", "Mahatma Gandhi"],
        answer: 0
      },
      {
        question: "What is the largest ocean on Earth?",
        options: ["Indian Ocean", "Pacific Ocean", "Atlantic Ocean", "Arctic Ocean"],
        answer: 1
      },
        {
        question: "What is the integration?",
        options: ["summation", " difference", "multiply ", " divide"],
        answer: 1
      },
        {
        question: "Who is Most Powerful King of indian history ?",
        options: [" Samudragupta", " Vikramaditya ", " Chnadragupta", " Ashoka"],
        answer: 4
      },

        {
        question: "Which gas do plants absorb from the atmosphere?",
        options: ["Oxygen", "Nitrogen", "Carbon Dioxide", "Helium"],
        answer: 2
      },
      {
        question: "The currency of Japan is?",
        options: ["Yuan", "Won", "Yen", "Peso"],
        answer: 2
      },
      {
        question: "Who is known as the Father of the Indian Constitution?",
        options: ["Jawaharlal Nehru", "Dr. B.R. Ambedkar", "Sardar Patel", "Subhash Chandra Bose"],
        answer: 1
      },
      {
        question: "Which continent has the most countries?",
        options: ["Europe", "Africa", "Asia", "South America"],
        answer: 1
      },
      {
        question: "What is the capital city of Australia?",
        options: ["Sydney", "Melbourne", "Canberra", "Perth"],
        answer: 2
      },
      {
        question: "Which element has the chemical symbol 'O'?",
        options: ["Gold", "Oxygen", "Osmium", "Silver"],
        answer: 1
      },
      {
        question: "The Great Wall of China is primarily built to protect against which group?",
        options: ["Mongols", "Romans", "Vikings", "Persians"],
        answer: 0
      },
      {
        question: "Which is the smallest prime number?",
        options: ["1", "2", "3", "5"],
        answer: 1
      },
      {
        question: "Which river is the longest in India?",
        options: ["Yamuna", "Ganga", "Godavari", "Brahmaputra"],
        answer: 1
      }
    ];

    const PROCTOR_CONFIG = {
      intervalMs: 2000,
      maxWarnings: 5,
      maxMoveRatio: 0.15,
      maxJitterRatio: 0.08,
      minFaceAreaRatio: 0.04,
      maxFaceAreaRatio: 0.55,
      maxCenterOffsetRatio: 0.25,
      maxConsecutiveLost: 2
    };

    const state = {
      candidateName: "",
      seatNo: "",
      questions: [],
      currentIndex: 0,
      responses: [],
      warnings: 0,
      proctorLog: [],
      snapshotData: "",
      chart: null,
      faceDetector: null,
      proctorInterval: null,
      lastFaceBox: null,
      lastFaceTime: null,
      lostFaceCount: 0
    };

    const loginForm = document.getElementById("login-form");
    const loginSection = document.getElementById("login-section");
    const testSection = document.getElementById("test-section");
    const resultSection = document.getElementById("result-section");
    const loginVideo = document.getElementById("login-video");
    const proctorVideo = document.getElementById("proctor-video");
    const loginSnapshot = document.getElementById("login-snapshot");
    const captureBtn = document.getElementById("capture-btn");
    const snapshotStatus = document.getElementById("snapshot-status");

    const questionTitle = document.getElementById("question-title");
    const questionText = document.getElementById("question-text");
    const optionsContainer = document.getElementById("options-container");
    const questionCounter = document.getElementById("question-counter");
    const attemptPanel = document.getElementById("attempt-panel");
    const candidateDisplay = document.getElementById("candidate-display");
    const faceStatus = document.getElementById("face-status");
    const warningCount = document.getElementById("warning-count");
    const proctorLog = document.getElementById("proctor-log");

    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const skipBtn = document.getElementById("skip-btn");
    const submitBtn = document.getElementById("submit-btn");

    const scoreDisplay = document.getElementById("score-display");
    const resultSubtitle = document.getElementById("result-subtitle");
    const resultTable = document.getElementById("result-table");
    const resultSnapshot = document.getElementById("result-snapshot");
    const proctorSummary = document.getElementById("proctor-summary");
    const downloadPdfBtn = document.getElementById("download-pdf-btn");

    function shuffle(array) {
      const items = [...array];
      for (let i = items.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [items[i], items[j]] = [items[j], items[i]];
      }
      return items;
    }

    async function initCamera(videoElement) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        videoElement.srcObject = stream;
        return stream;
      } catch (error) {
        console.error("Camera access denied:", error);
        snapshotStatus.textContent = "Camera access required for proctoring.";
        return null;
      }
    }

    function validateSeatNo(seat) {
      return /^T00\d{4}$/.test(seat.trim());
    }

    function updateAttemptPanel() {
      attemptPanel.innerHTML = "";
      state.responses.forEach((response, index) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = `attempt-badge ${
          index === state.currentIndex
            ? "attempt-current"
            : response.status === "answered"
            ? "attempt-answered"
            : response.status === "skipped"
            ? "attempt-skipped"
            : "attempt-unseen"
        }`;
        button.textContent = index + 1;
        button.addEventListener("click", () => navigateTo(index));
        attemptPanel.appendChild(button);
      });
    }

    function renderQuestion() {
      const current = state.questions[state.currentIndex];
      questionTitle.textContent = `Question ${state.currentIndex + 1}`;
      questionText.textContent = current.question;
      questionCounter.textContent = `${state.currentIndex + 1} / ${state.questions.length}`;
      optionsContainer.innerHTML = "";

      const labels = ["A", "B", "C", "D"];
      current.options.forEach((option, idx) => {
        const col = document.createElement("div");
        col.className = "col-md-6";
        const button = document.createElement("button");
        button.type = "button";
        button.className = "option-btn";
        if (state.responses[state.currentIndex].selected === idx) {
          button.classList.add("option-selected");
        }
        button.innerHTML = `
          <span class="option-letter">${labels[idx]}</span>
          <span>${option}</span>
        `;
        button.addEventListener("click", () => selectOption(idx));
        col.appendChild(button);
        optionsContainer.appendChild(col);
      });

      updateAttemptPanel();
      prevBtn.disabled = state.currentIndex === 0;
      nextBtn.textContent = state.currentIndex === state.questions.length - 1 ? "Review" : "Next";
    }

    function selectOption(index) {
      state.responses[state.currentIndex].selected = index;
      state.responses[state.currentIndex].status = "answered";
      renderQuestion();
    }

    function navigateTo(index) {
      state.currentIndex = index;
      renderQuestion();
    }

    function skipQuestion() {
      state.responses[state.currentIndex].status = "skipped";
      if (state.currentIndex < state.questions.length - 1) {
        state.currentIndex += 1;
        renderQuestion();
      }
    }

    function nextQuestion() {
      if (state.currentIndex < state.questions.length - 1) {
        state.responses[state.currentIndex].status =
          state.responses[state.currentIndex].selected === null
            ? "skipped"
            : "answered";
        state.currentIndex += 1;
        renderQuestion();
      } else {
        renderQuestion();
      }
    }

    function prevQuestion() {
      if (state.currentIndex > 0) {
        state.responses[state.currentIndex].status =
          state.responses[state.currentIndex].selected === null
            ? "skipped"
            : "answered";
        state.currentIndex -= 1;
        renderQuestion();
      }
    }

    function incrementWarning(reason) {
      state.warnings += 1;
      warningCount.textContent = `Warnings: ${state.warnings}/${PROCTOR_CONFIG.maxWarnings}`;
      faceStatus.className = "status-pill pill-warn";
      faceStatus.innerHTML = `<i class="bi bi-exclamation-circle"></i> Attention`;
      proctorLog.textContent = reason;
      state.proctorLog.push(`${new Date().toLocaleTimeString()}: ${reason}`);

      if (state.warnings >= PROCTOR_CONFIG.maxWarnings) {
        autoSubmit("Auto-submitted due to repeated proctoring warnings.");
      }
    }

    async function initFaceDetector() {
      if ("FaceDetector" in window) {
        state.faceDetector = new FaceDetector({ fastMode: true, maxDetectedFaces: 2 });
        return true;
      }
      return false;
    }

    function monitorProctoring() {
      // Replace your existing monitorProctoring with this:
async function monitorProctoring() {
  const model = faceDetection.SupportedModels.MediaPipeFaceDetector;
  const detectorConfig = { runtime: 'tfjs', modelType: 'short' };
  const detector = await faceDetection.createDetector(model, detectorConfig);

  state.proctorInterval = setInterval(async () => {
    if (!proctorVideo.srcObject) return;

    const estimationConfig = { flipHorizontal: false };
    const faces = await detector.estimateFaces(proctorVideo, estimationConfig);

    // 1. Multiple Person Detection ðŸ‘¥
    if (faces.length > 1) {
      incrementWarning("Multiple persons detected! Please stay alone.");
    } 
    // 2. Face Visibility ðŸ™ˆ
    else if (faces.length === 0) {
      state.lostFaceCount++;
      if (state.lostFaceCount > 2) {
        incrementWarning("No face detected. Keep your face in the frame.");
      }
    } 
    // 3. Eye Tracking / Looking Away ðŸ‘ï¸
    else {
      state.lostFaceCount = 0;
      const face = faces[0].box;
      
      // Calculate if face is too far left/right (Looking at second screen?)
      const videoCenter = proctorVideo.videoWidth / 2;
      const faceCenter = face.xMin + (face.width / 2);
      
      if (Math.abs(faceCenter - videoCenter) > (proctorVideo.videoWidth * 0.3)) {
        incrementWarning("Stop looking away from the screen!");
      }
    }
  }, 2000); // Check every 2 seconds
}
    function handleVisibilityChange() {
      if (document.hidden) {
        incrementWarning("Tab switch detected. Please stay on the test screen.");
      }
    }

    function autoSubmit(message) {
      clearInterval(state.proctorInterval);
      alert(message);
      finalizeTest();
    }

    function finalizeTest() {
      testSection.classList.add("d-none");
      resultSection.classList.remove("d-none");

      const scoreData = state.responses.map((response, index) => {
        const correctIndex = state.questions[index].answer;
        const isCorrect = response.selected === correctIndex;
        return {
          question: state.questions[index].question,
          selected: response.selected,
          correct: correctIndex,
          isCorrect
        };
      });

      const correctCount = scoreData.filter(item => item.isCorrect).length;
      const skippedCount = state.responses.filter(response => response.selected === null).length;
      const incorrectCount = state.questions.length - correctCount - skippedCount;

      scoreDisplay.textContent = `${correctCount} / ${state.questions.length}`;
      resultSubtitle.textContent = `Candidate: ${state.candidateName} | Seat No: ${state.seatNo}`;
      resultSnapshot.src = state.snapshotData;

      resultTable.innerHTML = scoreData.map((item, idx) => {
        const letterMap = ["A", "B", "C", "D"];
        const selectedText = item.selected !== null ? `${letterMap[item.selected]} - ${state.questions[idx].options[item.selected]}` : "Skipped";
        const correctText = `${letterMap[item.correct]} - ${state.questions[idx].options[item.correct]}`;
        return `
          <tr>
            <td>${idx + 1}</td>
            <td>${item.question}</td>
            <td>${selectedText}</td>
            <td>${correctText}</td>
            <td>
              <span class="badge ${item.isCorrect ? "text-bg-success" : item.selected === null ? "text-bg-secondary" : "text-bg-danger"}">
                ${item.isCorrect ? "Correct" : item.selected === null ? "Skipped" : "Incorrect"}
              </span>
            </td>
          </tr>
        `;
      }).join("");

      proctorSummary.innerHTML = state.proctorLog.length
        ? state.proctorLog.map(item => `<li>${item}</li>`).join("")
        : "<li>No proctoring warnings.</li>";

      renderChart(correctCount, incorrectCount, skippedCount);
    }

    function renderChart(correctCount, incorrectCount, skippedCount) {
      const ctx = document.getElementById("result-chart").getContext("2d");
      if (state.chart) state.chart.destroy();
      state.chart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Correct", "Incorrect", "Skipped"],
          datasets: [
            {
              data: [correctCount, incorrectCount, skippedCount],
              backgroundColor: ["#22c55e", "#ef4444", "#94a3b8"]
            }
          ]
        },
        options: {
          plugins: {
            legend: {
              position: "bottom"
            }
          }
        }
      });
    }

    function downloadPdf() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const pageWidth = doc.internal.pageSize.getWidth();
      let y = 40;

      doc.setFontSize(18);
      doc.text("GK Mock Test Result", 40, y);
      y += 20;
      doc.setFontSize(12);
      doc.text(`Name: ${state.candidateName}`, 40, y);
      y += 16;
      doc.text(`Seat No: ${state.seatNo}`, 40, y);
      y += 16;
      doc.text(`Score: ${scoreDisplay.textContent}`, 40, y);
      y += 20;

      if (state.snapshotData) {
        doc.setFontSize(12);
        doc.text("Candidate Snapshot:", 40, y);
        y += 10;
        doc.addImage(state.snapshotData, "PNG", 40, y, 120, 90);
      }

      const chartCanvas = document.getElementById("result-chart");
      if (chartCanvas) {
        const chartData = chartCanvas.toDataURL("image/png");
        doc.addImage(chartData, "PNG", pageWidth - 220, 60, 160, 120);
      }

      y += 120;
      doc.setFontSize(12);
      doc.text("Detailed Results:", 40, y);
      y += 14;

      const tableRows = [];
      state.responses.forEach((response, index) => {
        const correctIndex = state.questions[index].answer;
        const letterMap = ["A", "B", "C", "D"];
        const selectedText = response.selected !== null ? `${letterMap[response.selected]}` : "Skipped";
        const correctText = `${letterMap[correctIndex]}`;
        const status = response.selected === correctIndex ? "Correct" : response.selected === null ? "Skipped" : "Incorrect";
        tableRows.push([`${index + 1}`, selectedText, correctText, status]);
      });

      doc.setFontSize(10);
      doc.text("Q.No", 40, y);
      doc.text("Your", 90, y);
      doc.text("Correct", 140, y);
      doc.text("Status", 210, y);
      y += 12;

      tableRows.forEach(row => {
        doc.text(row[0], 40, y);
        doc.text(row[1], 90, y);
        doc.text(row[2], 140, y);
        doc.text(row[3], 210, y);
        y += 12;
      });

      const filename = `${state.candidateName}-${state.seatNo}.ans.pdf`;
      doc.save(filename);
    }

    captureBtn.addEventListener("click", () => {
      const context = loginSnapshot.getContext("2d");
      context.drawImage(loginVideo, 0, 0, loginSnapshot.width, loginSnapshot.height);
      state.snapshotData = loginSnapshot.toDataURL("image/png");
      snapshotStatus.textContent = "Snapshot captured.";
      snapshotStatus.classList.remove("text-danger");
      snapshotStatus.classList.add("text-success");
    });

    loginForm.addEventListener("submit", async event => {
      event.preventDefault();
      const name = document.getElementById("candidate-name").value.trim();
      const seat = document.getElementById("candidate-seat").value.trim();

      if (!name || !validateSeatNo(seat)) {
        alert("Please enter a valid name and seat number (T00xxxx).");
        return;
      }

      if (!state.snapshotData) {
        snapshotStatus.textContent = "Please capture your snapshot before starting.";
        snapshotStatus.classList.add("text-danger");
        return;
      }

      state.candidateName = name;
      state.seatNo = seat;
      candidateDisplay.textContent = `${name} (${seat})`;

      loginSection.classList.add("d-none");
      testSection.classList.remove("d-none");

      state.questions = shuffle(QUESTIONS).slice(0, 10);
      state.responses = state.questions.map((_, index) => ({
        selected: null,
        status: "unseen"
      }));

      renderQuestion();

      await initCamera(proctorVideo);
      await initFaceDetector();
      monitorProctoring();

      document.addEventListener("visibilitychange", handleVisibilityChange);
      window.addEventListener("blur", () => incrementWarning("Window focus lost. Please stay active."));
    });

    prevBtn.addEventListener("click", prevQuestion);
    nextBtn.addEventListener("click", nextQuestion);
    skipBtn.addEventListener("click", skipQuestion);
    submitBtn.addEventListener("click", () => {
      if (confirm("Are you sure you want to submit the test?")) {
        finalizeTest();
      }
    });

    downloadPdfBtn.addEventListener("click", downloadPdf);

    initCamera(loginVideo);
  </script>
</body>
</html>